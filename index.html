<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="h4xG5XuTjoTcM8fRui_yj0Dzy2go3ZTa3RfZBGwZmBg" />
    
    <!-- SEO Meta Tags (English) -->
    <title>QR Code Generator - VIN NESIA</title>
    <meta name="description" content="Create custom QR Codes with your logo for free. The VIN NESIA QR Code Generator supports Text, URL, WiFi, vCard, Location, and Files. Design your QR code with unique colors and styles.">
    <meta name="keywords" content="qr code generator, create qr code, free qr code, vin nesia, online qr code, qr code with logo, wifi qr code, vcard qr code, qr generator tool">
    <meta name="author" content="VIN NESIA">
    <link rel="canonical" href="https://qr.vinnesia.my.id">
    <link rel="icon" type="image/png" href="/favicon-v1.png" sizes="48x48">
    <link rel="shortcut icon" href="/favicon-v1.ico" type="image/x-icon">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://qr.vinnesia.my.id">
    <meta property="og:title" content="QR Code Generator - VIN NESIA">
    <meta property="og:description" content="Easily create custom QR Codes with your logo for free. Supports Text, URL, WiFi, vCard, and more.">
    <meta property="og:image" content="https://www.vinnesia.my.id/og-image.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://qr.vinnesia.my.id">
    <meta property="twitter:title" content="QR Code Generator - VIN NESIA">
    <meta property="twitter:description" content="Easily create custom QR Codes with your logo for free. Supports Text, URL, WiFi, vCard, and more.">
    <meta property="twitter:image" content="https://www.vinnesia.my.id/og-image.png">
    
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6MQ8QLENDT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6MQ8QLENDT');
</script>

    <script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    
    <style>
        :root {
            --color-background: #121212;
            --color-surface: #1e1e1e;
            --color-primary: #8A2BE2; /* Purple */
            --color-secondary: #FFD700; /* Gold */
            --color-text: #EAEAEA;
            --color-text-muted: #A0A0A0;
            --color-border: #333333;
            --color-action: #00897B; /* Teal/Green for Generate button */
            --color-success: #4CAF50;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 2rem auto;
            flex-grow: 1;
        }

        header {
            text-align: center;
            padding: 2rem 1rem;
            border-bottom: 1px solid var(--color-border);
            position: relative;
        }

        header h1 {
            margin: 0;
            color: var(--color-text);
            font-size: 2.8em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .logo-img {
            height: 50px;
            filter: drop-shadow(0 0 5px var(--color-secondary));
        }

        header p {
            color: var(--color-text-muted);
            font-size: 1.1em;
            margin-top: 0.5rem;
        }

        .user-info {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.9em;
        }

        .user-email {
            color: var(--color-success);
            font-weight: 600;
        }

        .logout-btn {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .logout-btn:hover {
            background-color: #9932CC;
        }

        main {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
        }

        .controls {
            flex: 2;
            background: var(--color-surface);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
        }

        .output {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--color-surface);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--color-border);
            min-height: 350px;
            position: sticky;
            top: 2rem;
            align-self: flex-start;
        }

        .tabs-grid-container {
            display: flex;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1.5rem;
        }

        .tab-button {
            padding: 0.8rem 1rem;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            color: var(--color-text-muted);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .tab-button:hover { color: var(--color-text); }
        .tab-button.active {
            color: var(--color-secondary);
            font-weight: bold;
            border-bottom-color: var(--color-secondary);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--color-text); }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            background-color: #2c2c2c;
            color: var(--color-text);
        }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-group input[type="color"] { padding: 0.2rem; height: 40px; }

        .file-warning {
            background-color: rgba(255, 215, 0, 0.1);
            color: var(--color-secondary);
            padding: 0.8rem;
            border: 1px solid var(--color-secondary);
            border-radius: 6px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        #qr-code-container {
            width: 100%;
            max-width: 300px;
            height: auto;
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            box-sizing: border-box;
            transition: background-color 0.3s ease;
        }
        #qr-code canvas, #qr-code svg { border-radius: 4px; display: block; width: 100%; height: auto; }

        .download-buttons { display: flex; gap: 1rem; width: 100%; }
        .btn {
            flex-grow: 1;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            text-decoration: none;
            border: none;
        }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: #9932CC; }
        .btn-secondary { background-color: var(--color-secondary); color: var(--color-background); }
        .btn-secondary:hover { background-color: #FFC700; }
        
        .btn-generate {
            background-color: var(--color-action);
            color: white;
            width: 100%;
            padding: 1rem;
            margin-top: auto; /* Pushes button to the bottom */
            font-size: 1.2em;
        }
        .btn-generate:hover { background-color: #00695C; }
        
        .btn-outline { background-color: transparent; color: var(--color-secondary); border: 1px solid var(--color-secondary); }
        .btn-outline:hover { background-color: var(--color-secondary); color: var(--color-background); }

        /* Disabled state for buttons when not logged in */
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #555;
            color: #999;
        }

        .disabled-overlay {
            position: relative;
        }

        .disabled-overlay::after {
            content: '🔒 Login Required';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            color: var(--color-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            border-radius: 12px;
            z-index: 10;
            cursor: pointer;
        }

        /* Login Modal Styles */
        .login-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .login-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-modal-content {
            background: var(--color-surface);
            padding: 3rem 2rem;
            border-radius: 12px;
            border: 1px solid var(--color-border);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .login-modal h2 {
            color: var(--color-secondary);
            margin-bottom: 1rem;
            font-size: 2em;
        }

        .login-modal p {
            color: var(--color-text-muted);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .login-modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .login-modal .btn {
            flex: none;
            min-width: 120px;
        }

        footer {
            background-color: #0a0a0a;
            color: var(--color-text-muted);
            text-align: center;
            padding: 2.5rem 1.5rem;
            margin-top: 2rem;
            border-top: 1px solid var(--color-border);
        }
        .footer-content { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
        .footer-links { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem 2rem; list-style: none; padding: 0; margin: 0; }
        .footer-links a { color: var(--color-text-muted); text-decoration: none; transition: color 0.3s ease; }
        .footer-links a:hover { color: var(--color-secondary); }
        .copyright { margin-top: 1rem; font-size: 0.9em; }

        /* --- MEDIA QUERIES FOR RESPONSIVE DESIGN --- */
        @media (max-width: 992px) {
            main { flex-direction: column; }
            .output { position: static; align-self: auto; }
            
            /* --- GRID TAB LAYOUT FOR TABLET & MOBILE --- */
            .tabs-grid-container {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 0.5rem;
                border-bottom: none;
            }
            .tab-button {
                border: 1px solid var(--color-border);
                border-radius: 6px;
                padding: 0.75rem 0.5rem;
                font-size: 0.85em;
                text-align: center;
                border-bottom: 1px solid var(--color-border); /* Reset border */
            }
            .tab-button.active {
                border-color: var(--color-secondary);
                background-color: #2a2a2a;
            }

            .user-info {
                position: static;
                justify-content: center;
                margin-top: 1rem;
            }
        }

        @media (max-width: 768px) {
            .container { width: 95%; margin: 1.5rem auto; }
            header h1 { font-size: 2.2em; } .logo-img { height: 40px; }
            .controls, .output { padding: 1.5rem; }
            .footer-links { flex-direction: column; gap: 1rem; }
            
            .login-modal-content {
                padding: 2rem 1.5rem;
            }

            .login-modal-buttons {
                flex-direction: column;
            }
        }
        
        @media (max-width: 576px) {
            header h1 { font-size: 2em; } .logo-img { height: 35px; }
            .download-buttons { flex-direction: column; }
            .btn { padding: 1rem; }
            #qr-code-container { padding: 0.5rem; }
            .tabs-grid-container { grid-template-columns: repeat(3, 1fr); } /* 3 columns for very small screens */
        }
    </style>
</head>
<body>

    <header>
        <h1>
            <img src="logo.png" alt="VIN NESIA Logo" class="logo-img" onerror="this.style.display='none'">
            VIN NESIA
        </h1>
        <p>QR Code Generator</p>
        
        <!-- User Info Section -->
        <div id="user-info" class="user-info" style="display: none;">
            <span id="user-email" class="user-email"></span>
            <button id="logout-btn" class="logout-btn">Logout</button>
        </div>
    </header>

    <!-- Login Modal -->
    <div id="login-modal" class="login-modal">
        <div class="login-modal-content">
            <h2>🔐 Authentication Required</h2>
            <p>Please log in to use the QR Code Generator. Your account allows you to access all features and save your preferences.</p>
            <div class="login-modal-buttons">
                <button id="modal-login-btn" class="btn btn-primary">Login</button>
                <button id="modal-register-btn" class="btn btn-secondary">Register</button>
            </div>
        </div>
    </div>

    <main class="container">
        <div class="controls" id="controls-section">
            <div class="tabs-grid-container">
                <button class="tab-button active" onclick="openTab(event, 'text')">📝 Text/URL</button>
                <button class="tab-button" onclick="openTab(event, 'wifi')">📶 WiFi</button>
                <button class="tab-button" onclick="openTab(event, 'vcard')">👤 vCard</button>
                <button class="tab-button" onclick="openTab(event, 'email')">📧 Email</button>
                <button class="tab-button" onclick="openTab(event, 'sms')">📱 SMS</button>
                <button class="tab-button" onclick="openTab(event, 'geo')">📍 Location</button>
                <button class="tab-button" onclick="openTab(event, 'file')">📁 File</button>
                <button class="tab-button" onclick="openTab(event, 'event')">🗓️ Event</button>
                <button class="tab-button" onclick="openTab(event, 'crypto')">💰 Crypto</button>
                <button class="tab-button" onclick="openTab(event, 'phone')">☎️ Phone</button>
                <button class="tab-button" onclick="openTab(event, 'whatsapp')">💬 WhatsApp</button>
                <button class="tab-button" onclick="openTab(event, 'social')">🌐 Social</button>
                <button class="tab-button" onclick="openTab(event, 'appstore')">📱 App Store</button>
                <button class="tab-button" onclick="openTab(event, 'multilang')">🌍 Multi-Lang</button>
                <button class="tab-button" onclick="openTab(event, 'htmlcustom')">📄 HTML</button>
            </div>

            <div id="text" class="tab-content active"><div class="form-group"><label for="text-input">Your Text or URL</label><textarea id="text-input" placeholder="e.g., https://www.vinnesia.my.id"></textarea></div></div>
            <div id="wifi" class="tab-content"><div class="form-group"><label for="wifi-ssid">Network Name (SSID)</label><input type="text" id="wifi-ssid" placeholder="MyWiFiNetwork"></div><div class="form-group"><label for="wifi-password">Password</label><input type="text" id="wifi-password" placeholder="SecretPassword"></div><div class="form-group"><label for="wifi-encryption">Encryption</label><select id="wifi-encryption"><option value="WPA">WPA/WPA2</option><option value="WEP">WEP</option><option value="nopass">None</option></select></div></div>
            <div id="vcard" class="tab-content"><div class="form-group"><label for="vcard-name">Full Name</label><input type="text" id="vcard-name"></div><div class="form-group"><label for="vcard-phone">Phone</label><input type="tel" id="vcard-phone"></div><div class="form-group"><label for="vcard-email">Email</label><input type="email" id="vcard-email"></div><div class="form-group"><label for="vcard-org">Organization</label><input type="text" id="vcard-org"></div><div class="form-group"><label for="vcard-url">Website</label><input type="url" id="vcard-url"></div></div>
            <div id="email" class="tab-content"><div class="form-group"><label for="email-to">Recipient Email</label><input type="email" id="email-to" placeholder="recipient@example.com"></div><div class="form-group"><label for="email-subject">Subject</label><input type="text" id="email-subject"></div><div class="form-group"><label for="email-body">Message</label><textarea id="email-body"></textarea></div></div>
            <div id="sms" class="tab-content"><div class="form-group"><label for="sms-to">Phone Number</label><input type="tel" id="sms-to" placeholder="+1234567890"></div><div class="form-group"><label for="sms-body">Message</label><textarea id="sms-body"></textarea></div></div>
            <div id="geo" class="tab-content"><div class="form-group"><label for="geo-lat">Latitude</label><input type="text" id="geo-lat" placeholder="40.7128"></div><div class="form-group"><label for="geo-lon">Longitude</label><input type="text" id="geo-lon" placeholder="-74.0060"></div></div>
            <div id="file" class="tab-content"><div class="form-group"><label for="file-input">Upload File</label><input type="file" id="file-input"><div class="file-warning"><strong>Warning:</strong> For very small files (< 2KB) only. Large files will create unscannable QR codes. For larger files, upload them to a cloud service and create a QR code from the share link.</div></div></div>
            <div id="event" class="tab-content">
                <div class="form-group"><label for="event-summary">Event Title</label><input type="text" id="event-summary" placeholder="My Event"></div>
                <div class="form-group"><label for="event-start">Start Date (YYYY-MM-DDTHH:MM)</label><input type="text" id="event-start" placeholder="2023-12-31T23:59"></div>
                <div class="form-group"><label for="event-end">End Date (YYYY-MM-DDTHH:MM)</label><input type="text" id="event-end" placeholder="2024-01-01T00:01"></div>
                <div class="form-group"><label for="event-location">Location</label><input type="text" id="event-location" placeholder="Jakarta, Indonesia"></div>
                <div class="form-group"><label for="event-description">Description</label><textarea id="event-description" placeholder="Event details..."></textarea></div>
            </div>
            <div id="crypto" class="tab-content">
                <div class="form-group"><label for="crypto-type">Crypto Type</label><select id="crypto-type"><option value="bitcoin">Bitcoin</option><option value="ethereum">Ethereum</option><option value="litecoin">Litecoin</option></select></div>
                <div class="form-group"><label for="crypto-address">Wallet Address</label><input type="text" id="crypto-address" placeholder="1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"></div>
                <div class="form-group"><label for="crypto-amount">Amount</label><input type="text" id="crypto-amount" placeholder="0.001"></div>
                <div class="form-group"><label for="crypto-label">Label</label><input type="text" id="crypto-label" placeholder="Donation"></div>
            </div>
            <div id="phone" class="tab-content">
                <div class="form-group"><label for="phone-number">Phone Number</label><input type="tel" id="phone-number" placeholder="+6281234567890"></div>
            </div>
            <div id="whatsapp" class="tab-content">
                <div class="form-group"><label for="whatsapp-number">Phone Number</label><input type="tel" id="whatsapp-number" placeholder="+6281234567890"></div>
                <div class="form-group"><label for="whatsapp-message">Pre-filled Message</label><textarea id="whatsapp-message" placeholder="Hello!"></textarea></div>
            </div>
            <div id="social" class="tab-content">
                <div class="form-group"><label for="social-platform">Platform</label><select id="social-platform"><option value="instagram">Instagram</option><option value="telegram">Telegram</option><option value="tiktok">TikTok</option></select></div>
                <div class="form-group"><label for="social-username">Username</label><input type="text" id="social-username" placeholder="username"></div>
            </div>
            <div id="appstore" class="tab-content">
                <div class="form-group"><label for="appstore-platform">Platform</label><select id="appstore-platform"><option value="playstore">Google Play Store</option><option value="appstore">Apple App Store</option></select></div>
                <div class="form-group"><label for="appstore-id">App ID or URL</label><input type="text" id="appstore-id" placeholder="com.example.app or full URL"></div>
            </div>
            <div id="multilang" class="tab-content">
                <div class="form-group"><label for="multilang-baseurl">Base URL</label><input type="url" id="multilang-baseurl" placeholder="https://example.com"></div>
                <div class="form-group"><label for="multilang-langparam">Language Parameter (e.g., lang=en)</label><input type="text" id="multilang-langparam" placeholder="lang=en"></div>
            </div>
            <div id="htmlcustom" class="tab-content">
                <div class="form-group"><label for="htmlcustom-content">HTML Content</label><textarea id="htmlcustom-content" placeholder="<h1>Hello World</h1>"></textarea></div>
            </div>

            <h3 style="margin-top: 2rem; border-top: 1px solid var(--color-border); padding-top: 1.5rem; color: var(--color-secondary);">Design Options</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="form-group"><label for="dot-color">Dot Color</label><input type="color" id="dot-color" value="#000000"></div>
                <div class="form-group"><label for="bg-color">Background Color</label><input type="color" id="bg-color" value="#ffffff"></div>
                <div class="form-group"><label for="dot-style">Dot Style</label><select id="dot-style"><option value="square">Square</option><option value="dots">Dots</option><option value="rounded">Rounded</option><option value="extra-rounded">Extra Rounded</option><option value="classy">Classy</option><option value="classy-rounded">Classy Rounded</option></select></div>
                <div class="form-group"><label for="logo-upload">Upload Logo</label><input type="file" id="logo-upload" accept="image/*"></div>
            </div>

            <button id="generate-btn" class="btn btn-generate">Generate QR Code</button>
        </div>

        <div class="output" id="output-section">
            <div id="qr-code-container">
                <div id="qr-code"></div>
            </div>
            <div class="download-buttons">
                <button id="download-png" class="btn btn-primary">Download PNG</button>
                <button id="download-svg" class="btn btn-secondary">Download SVG</button>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <a href="https://www.vinnesia.my.id" class="btn btn-outline">Back to Homepage</a>
            <ul class="footer-links">
                <li><a href="mailto:support@vinnesia.my.id">📧 Email</a></li>
                <li><a href="https://instagram.com/vin.nesia.id" target="_blank" rel="noopener noreferrer">🧑‍💻 Instagram</a></li>
                <li><a href="https://wa.me/62895354511777" target="_blank" rel="noopener noreferrer">📱 WhatsApp</a></li>
                <li><a href="https://www.vinnesia.my.id/privacy" target="_blank">Privacy Policy</a></li>
            </ul>
            <div class="copyright">
                © 2025 VIN NESIA. All rights reserved. <br> 📍 Indonesia
            </div>
        </div>
    </footer>

    <!-- Firebase Configuration -->
    <script type="module" src="firebase-config.js"></script>

    <script>
class QRGenerator {
    constructor() {
        this.currentTab = 'text';
        this.logoImage = null;
        this.fileDataUrl = null;
        this.isUserLoggedIn = false;
        this.qrCode = null;
        this.previewTimeout = null;
        this.isInitialized = false;
        
        // Bind methods
        this.init = this.init.bind(this);
        this.generateQR = this.generateQR.bind(this);
        this.generatePreviewQR = this.generatePreviewQR.bind(this);
        this.openTab = this.openTab.bind(this);
        this.requireAuth = this.requireAuth.bind(this);
    }

    async init() {
        try {
            await this.waitForQRLibrary();
            this.initializeQRCode();
            this.setupEventListeners();
            this.checkAuthState();
            this.setupUI();
            this.isInitialized = true;
            console.log('QR Generator initialized successfully');
        } catch (error) {
            console.error('Failed to initialize QR Generator:', error);
            this.showErrorMessage('Failed to load QR Generator. Please refresh the page.');
        }
    }

    waitForQRLibrary() {
        return new Promise((resolve, reject) => {
            let attempts = 0;
            const maxAttempts = 50; // 5 seconds timeout
            
            const checkLibrary = () => {
                if (window.QRCodeStyling) {
                    resolve();
                } else if (attempts < maxAttempts) {
                    attempts++;
                    setTimeout(checkLibrary, 100);
                } else {
                    reject(new Error('QR Code library failed to load'));
                }
            };
            
            checkLibrary();
        });
    }

    initializeQRCode() {
        this.qrCode = new QRCodeStyling({
            width: 300,
            height: 300,
            data: "Welcome to VIN NESIA QR Generator!",
            image: "",
            dotsOptions: { 
                color: "#000000", 
                type: "square" 
            },
            backgroundOptions: { 
                color: "#ffffff" 
            },
            imageOptions: { 
                crossOrigin: "anonymous", 
                margin: 5, 
                imageSize: 0.4 
            },
            qrOptions: { 
                errorCorrectionLevel: 'H' 
            }
        });

        const qrContainer = document.getElementById("qr-code");
        if (qrContainer) {
            qrCode.append(qrContainer);
        }
    }

    setupEventListeners() {
        // Tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const tabName = this.getTabNameFromButton(e.target);
                if (tabName) {
                    this.openTab(e, tabName);
                }
            });
        });

        // Generate button
        const generateBtn = document.getElementById('generate-btn');
        if (generateBtn) {
            generateBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.generateQrCode();
            });
        }

        // Download buttons
        const downloadPNG = document.getElementById('download-png');
        const downloadSVG = document.getElementById('download-svg');
        
        if (downloadPNG) {
            downloadPNG.addEventListener('click', () => {
                this.requireAuth(() => this.downloadQR('png'));
            });
        }
        
        if (downloadSVG) {
            downloadSVG.addEventListener('click', () => {
                this.requireAuth(() => this.downloadQR('svg'));
            });
        }

        // File upload listeners
        const logoUpload = document.getElementById('logo-upload');
        const fileInput = document.getElementById('file-input');
        
        if (logoUpload) {
            logoUpload.addEventListener('change', (e) => this.handleLogoUpload(e));
        }
        
        if (fileInput) {
            fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
        }

        // Modal listeners
        this.setupModalListeners();
        
        // Input listeners for real-time preview
        this.setupPreviewListeners();
        
        // Auth button listeners
        this.setupAuthListeners();
    }

    getTabNameFromButton(button) {
        const text = button.textContent.toLowerCase();
        if (text.includes('text') || text.includes('url')) return 'text';
        if (text.includes('wifi')) return 'wifi';
        if (text.includes('vcard')) return 'vcard';
        if (text.includes('email')) return 'email';
        if (text.includes('sms')) return 'sms';
        if (text.includes('location')) return 'geo';
        if (text.includes('file')) return 'file';
        if (text.includes('event')) return 'event';
        if (text.includes('crypto')) return 'crypto';
        if (text.includes('phone')) return 'phone';
        if (text.includes('whatsapp')) return 'whatsapp';
        if (text.includes('social')) return 'social';
        if (text.includes('app store')) return 'appstore';
        if (text.includes('multi-lang')) return 'multilang';
        if (text.includes('html')) return 'htmlcustom';
        return null;
    }

    setupModalListeners() {
        const modal = document.getElementById('login-modal');
        const modalLogin = document.getElementById('modal-login-btn');
        const modalRegister = document.getElementById('modal-register-btn');

        if (modalLogin) {
            modalLogin.addEventListener('click', () => {
                const returnUrl = encodeURIComponent(window.location.href);
                window.location.href = `login.html?returnUrl=${returnUrl}`;
            });
        }

        if (modalRegister) {
            modalRegister.addEventListener('click', () => {
                const returnUrl = encodeURIComponent(window.location.href);
                window.location.href = `login.html?returnUrl=${returnUrl}`;
            });
        }

        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    this.hideLoginModal();
                }
            });
        }

        // Handle overlay clicks
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('login-overlay')) {
                this.showLoginModal();
            }
        });
    }

    setupPreviewListeners() {
        const inputs = document.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            // Skip file inputs and buttons
            if (input.type === 'file' || input.type === 'button') return;
            
            ['input', 'change', 'keyup'].forEach(event => {
                input.addEventListener(event, () => {
                    if (!this.isUserLoggedIn) {
                        this.debouncePreviewUpdate();
                    }
                });
            });
        });
    }

    setupAuthListeners() {
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                await this.logout();
            });
        }
    }

    debouncePreviewUpdate() {
        if (this.previewTimeout) {
            clearTimeout(this.previewTimeout);
        }
        
        this.previewTimeout = setTimeout(() => {
            this.generatePreviewQR();
        }, 300); // Reduced debounce time for better UX
    }

    checkAuthState() {
        // Check localStorage first
        const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
        this.updateUIForAuthState(isLoggedIn);

        // Set up Firebase auth listener if available
        this.setupFirebaseListener();
    }

    setupFirebaseListener() {
        if (typeof window !== 'undefined') {
            window.addEventListener('authStateChanged', (event) => {
                this.updateUIForAuthState(event.detail.loggedIn);
            });
        }
    }

    updateUIForAuthState(loggedIn) {
        this.isUserLoggedIn = loggedIn;
        
        if (loggedIn) {
            this.handleLoggedInState();
        } else {
            this.handleLoggedOutState();
        }
    }

    handleLoggedInState() {
        const userEmail = localStorage.getItem('userEmail');
        const userInfo = document.getElementById('user-info');
        const userEmailEl = document.getElementById('user-email');
        
        if (userEmailEl && userEmail) {
            userEmailEl.textContent = userEmail;
        }
        
        if (userInfo) {
            userInfo.style.display = 'flex';
        }

        this.removeLoginRequiredOverlays();
        this.enableAllControls();
        this.hideLoginModal();
        
        // Generate actual QR if we have data
        setTimeout(() => {
            this.generateQR();
        }, 100);
    }

    handleLoggedOutState() {
        const userInfo = document.getElementById('user-info');
        if (userInfo) {
            userInfo.style.display = 'none';
        }

        this.addLoginRequiredOverlays();
        this.enablePreviewMode();
        
        // Generate preview QR
        setTimeout(() => {
            this.generatePreviewQR();
        }, 100);
    }

    enableAllControls() {
        document.querySelectorAll('button').forEach(btn => {
            btn.disabled = false;
        });
        
        document.querySelectorAll('input, textarea, select').forEach(input => {
            input.disabled = false;
        });
    }

    enablePreviewMode() {
        // Enable all inputs for preview
        document.querySelectorAll('input, textarea, select').forEach(input => {
            input.disabled = false;
        });
        
        // Enable tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.disabled = false;
        });
        
        // Disable action buttons
        const actionButtons = ['generate-btn', 'download-png', 'download-svg'];
        actionButtons.forEach(btnId => {
            const btn = document.getElementById(btnId);
            if (btn) btn.disabled = true;
        });
    }

    addLoginRequiredOverlays() {
        this.removeLoginRequiredOverlays(); // Clean first
        
        const generateBtn = document.getElementById('generate-btn');
        const downloadArea = document.querySelector('.download-buttons');
        
        if (generateBtn) {
            const overlay = this.createLoginOverlay('🔒 Login to Generate QR Code');
            const parent = generateBtn.parentElement;
            parent.style.position = 'relative';
            parent.appendChild(overlay);
        }
        
        if (downloadArea) {
            const overlay = this.createLoginOverlay('🔒 Login to Download');
            downloadArea.style.position = 'relative';
            downloadArea.appendChild(overlay);
        }
    }

    removeLoginRequiredOverlays() {
        document.querySelectorAll('.login-overlay').forEach(overlay => {
            overlay.remove();
        });
    }

    createLoginOverlay(text) {
        const overlay = document.createElement('div');
        overlay.className = 'login-overlay';
        overlay.textContent = text;
        
        const styles = {
            position: 'absolute',
            top: '0',
            left: '0',
            right: '0',
            bottom: '0',
            background: 'linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(138,43,226,0.4) 50%, rgba(0,0,0,0.9) 100%)',
            color: '#FFD700',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontWeight: 'bold',
            fontSize: '1.1em',
            borderRadius: '8px',
            zIndex: '10',
            cursor: 'pointer',
            backdropFilter: 'blur(2px)',
            transition: 'all 0.3s ease'
        };
        
        Object.assign(overlay.style, styles);
        
        overlay.addEventListener('click', () => this.showLoginModal());
        
        overlay.addEventListener('mouseover', () => {
            overlay.style.background = 'linear-gradient(135deg, rgba(0,0,0,0.95) 0%, rgba(138,43,226,0.5) 50%, rgba(0,0,0,0.95) 100%)';
            overlay.style.fontSize = '1.2em';
        });
        
        overlay.addEventListener('mouseout', () => {
            overlay.style.background = 'linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(138,43,226,0.4) 50%, rgba(0,0,0,0.9) 100%)';
            overlay.style.fontSize = '1.1em';
        });
        
        return overlay;
    }

    showLoginModal() {
        const modal = document.getElementById('login-modal');
        if (modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
    }

    hideLoginModal() {
        const modal = document.getElementById('login-modal');
        if (modal) {
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }
    }

    requireAuth(callback) {
        if (!this.isUserLoggedIn) {
            this.showLoginModal();
            return false;
        }
        callback();
        return true;
    }

    openTab(evt, tabName) {
        this.currentTab = tabName;
        
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(tb => {
            tb.classList.remove('active');
        });
        evt.currentTarget.classList.add('active');
        
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(tc => {
            tc.classList.remove('active');
        });
        
        const targetTab = document.getElementById(tabName);
        if (targetTab) {
            targetTab.classList.add('active');
        }
        
        // Generate appropriate QR
        setTimeout(() => {
            if (this.isUserLoggedIn) {
                this.generateQR();
            } else {
                this.generatePreviewQR();
            }
        }, 50);
    }

    generateQrCode() {
        this.requireAuth(() => {
            this.generateQR();
        });
    }

    generateQR() {
        if (!this.qrCode) return;
        
        try {
            const data = this.getQRData();
            const options = this.getQROptions();
            
            this.qrCode.update({
                data: data || "https://qr.vinnesia.my.id",
                ...options
            });
            
            this.removePreviewWatermark();
            this.updateQRContainer(options.backgroundOptions.color);
            
        } catch (error) {
            console.error('Error generating QR code:', error);
            this.showErrorMessage('Error generating QR code. Please check your input.');
        }
    }

    generatePreviewQR() {
        if (!this.qrCode) return;
        
        try {
            const previewData = this.getPreviewData();
            
            this.qrCode.update({
                data: previewData,
                image: null,
                dotsOptions: { 
                    color: "#666666", 
                    type: "square" 
                },
                backgroundOptions: { 
                    color: "transparent" 
                }
            });
            
            setTimeout(() => {
                this.addPreviewWatermark();
            }, 100);
            
        } catch (error) {
            console.error('Error generating preview QR:', error);
        }
    }

    getQRData() {
        const getValue = (id) => {
            const el = document.getElementById(id);
            return el ? el.value.trim() : '';
        };

        switch (this.currentTab) {
            case 'text':
                return getValue('text-input') || "https://qr.vinnesia.my.id";
                
            case 'wifi':
                const ssid = getValue('wifi-ssid');
                const password = getValue('wifi-password');
                const encryption = getValue('wifi-encryption');
                return ssid ? `WIFI:T:${encryption};S:${ssid};P:${password};;` : '';
                
            case 'vcard':
                const name = getValue('vcard-name');
                const phone = getValue('vcard-phone');
                const email = getValue('vcard-email');
                const org = getValue('vcard-org');
                const url = getValue('vcard-url');
                return name ? `BEGIN:VCARD\nVERSION:3.0\nFN:${name}\nTEL:${phone}\nEMAIL:${email}\nORG:${org}\nURL:${url}\nEND:VCARD` : '';
                
            case 'email':
                const to = getValue('email-to');
                const subject = getValue('email-subject');
                const body = getValue('email-body');
                return to ? `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}` : '';
                
            case 'sms':
                const smsTo = getValue('sms-to');
                const smsBody = getValue('sms-body');
                return smsTo ? `SMSTO:${smsTo}:${encodeURIComponent(smsBody)}` : '';
                
            case 'geo':
                const lat = getValue('geo-lat');
                const lon = getValue('geo-lon');
                return (lat && lon) ? `geo:${lat},${lon}` : '';
                
            case 'file':
                return this.fileDataUrl || '';
                
            case 'event':
                return this.getEventData();
                
            case 'crypto':
                return this.getCryptoData();
                
            case 'phone':
                const phoneNumber = getValue('phone-number');
                return phoneNumber ? `tel:${phoneNumber}` : '';
                
            case 'whatsapp':
                const whatsappNumber = getValue('whatsapp-number');
                const whatsappMessage = getValue('whatsapp-message');
                return whatsappNumber ? `https://wa.me/${whatsappNumber.replace('+', '')}${whatsappMessage ? `?text=${encodeURIComponent(whatsappMessage)}` : ''}` : '';
                
            case 'social':
                return this.getSocialData();
                
            case 'appstore':
                return this.getAppStoreData();
                
            case 'multilang':
                const baseUrl = getValue('multilang-baseurl');
                const langParam = getValue('multilang-langparam');
                return (baseUrl && langParam) ? `${baseUrl}?${langParam}` : '';
                
            case 'htmlcustom':
                const htmlContent = getValue('htmlcustom-content');
                return htmlContent ? `data:text/html;base64,${btoa(htmlContent)}` : '';
                
            default:
                return "https://qr.vinnesia.my.id";
        }
    }

    getEventData() {
        const getValue = (id) => {
            const el = document.getElementById(id);
            return el ? el.value.trim() : '';
        };

        const summary = getValue('event-summary');
        const start = getValue('event-start').replace(/[-:]/g, '');
        const end = getValue('event-end').replace(/[-:]/g, '');
        const location = getValue('event-location');
        const description = getValue('event-description');
        
        if (summary && start && end) {
            return `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:${summary}\nDTSTART:${start}\nDTEND:${end}\nLOCATION:${location}\nDESCRIPTION:${description}\nEND:VEVENT\nEND:VCALENDAR`;
        }
        return '';
    }

    getCryptoData() {
        const getValue = (id) => {
            const el = document.getElementById(id);
            return el ? el.value.trim() : '';
        };

        const cryptoType = getValue('crypto-type');
        const address = getValue('crypto-address');
        const amount = getValue('crypto-amount');
        const label = getValue('crypto-label');
        
        if (address) {
            let url = `${cryptoType}:${address}`;
            const params = [];
            if (amount) params.push(`amount=${amount}`);
            if (label) params.push(`label=${encodeURIComponent(label)}`);
            if (params.length > 0) url += `?${params.join('&')}`;
            return url;
        }
        return '';
    }

    getSocialData() {
        const getValue = (id) => {
            const el = document.getElementById(id);
            return el ? el.value.trim() : '';
        };

        const platform = getValue('social-platform');
        const username = getValue('social-username');
        
        if (username) {
            const platformUrls = {
                'instagram': `https://instagram.com/${username}`,
                'telegram': `https://t.me/${username}`,
                'tiktok': `https://tiktok.com/@${username}`
            };
            return platformUrls[platform] || '';
        }
        return '';
    }

    getAppStoreData() {
        const getValue = (id) => {
            const el = document.getElementById(id);
            return el ? el.value.trim() : '';
        };

        const appPlatform = getValue('appstore-platform');
        const appId = getValue('appstore-id');
        
        if (appId) {
            if (appId.startsWith('http')) return appId;
            
            if (appPlatform === 'playstore') {
                return `https://play.google.com/store/apps/details?id=${appId}`;
            } else if (appPlatform === 'appstore') {
                return `https://apps.apple.com/app/id${appId}`;
            }
        }
        return '';
    }

    getPreviewData() {
        const previews = {
            'text': "https://qr.vinnesia.my.id - Login to customize!",
            'wifi': "WIFI:T:WPA;S:SampleNetwork;P:••••••••;;",
            'vcard': "BEGIN:VCARD\nVERSION:3.0\nFN:Sample User\nTEL:+123456789\nEMAIL:user@example.com\nORG:VIN NESIA\nEND:VCARD",
            'email': "mailto:sample@example.com?subject=Sample Subject&body=Sample message",
            'sms': "SMSTO:+123456789:Sample SMS message",
            'geo': "geo:-6.2088,106.8456",
            'phone': "tel:+6281234567890",
            'whatsapp': "https://wa.me/6281234567890?text=Hello!",
            'crypto': "bitcoin:1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa?amount=0.001",
            'social': "https://instagram.com/sample_user",
            'appstore': "https://play.google.com/store/apps/details?id=com.sample.app",
            'event': "BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:Sample Event\nDTSTART:20241225T120000\nDTEND:20241225T140000\nEND:VEVENT\nEND:VCALENDAR",
            'multilang': "https://example.com?lang=en",
            'htmlcustom': "data:text/html;base64,PGgxPkhlbGxvIFdvcmxkITwvaDE+",
            'file': "data:text/plain;base64,U2FtcGxlIEZpbGU="
        };
        
        return previews[this.currentTab] || `${this.currentTab.toUpperCase()} - Login to create custom QR codes!`;
    }

    getQROptions() {
        const getValue = (id) => {
            const el = document.getElementById(id);
            return el ? el.value : '';
        };

        return {
            image: this.logoImage,
            dotsOptions: { 
                color: getValue('dot-color') || "#000000", 
                type: getValue('dot-style') || "square" 
            },
            backgroundOptions: { 
                color: "transparent" 
            }
        };
    }

    updateQRContainer(bgColor) {
        const container = document.getElementById('qr-code-container');
        if (container) {
            container.style.backgroundColor = bgColor || '#ffffff';
        }
    }

    addPreviewWatermark() {
        this.removePreviewWatermark();
        
        const qrContainer = document.getElementById('qr-code-container');
        if (!qrContainer) return;
        
        const watermark = document.createElement('div');
        watermark.id = 'preview-watermark';
        watermark.textContent = 'PREVIEW';
        
        const styles = {
            position: 'absolute',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%) rotate(-45deg)',
            background: 'rgba(255, 215, 0, 0.15)',
            color: 'rgba(255, 215, 0, 0.8)',
            padding: '8px 16px',
            fontSize: '14px',
            fontWeight: 'bold',
            border: '2px solid rgba(255, 215, 0, 0.4)',
            borderRadius: '6px',
            pointerEvents: 'none',
            zIndex: '5',
            letterSpacing: '2px'
        };
        
        Object.assign(watermark.style, styles);
        
        qrContainer.style.position = 'relative';
        qrContainer.appendChild(watermark);
    }

    removePreviewWatermark() {
        const watermark = document.getElementById('preview-watermark');
        if (watermark) {
            watermark.remove();
        }
    }

    handleLogoUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            this.showErrorMessage('Please select a valid image file.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            this.logoImage = e.target.result;
            if (this.isUserLoggedIn) {
                this.generateQR();
            }
        };
        reader.onerror = () => {
            this.showErrorMessage('Failed to read logo file.');
        };
        reader.readAsDataURL(file);
    }

    handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (file.size > 2048) { // 2KB limit
            this.showErrorMessage('File too large. Please select a file smaller than 2KB.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            this.fileDataUrl = e.target.result;
            if (this.isUserLoggedIn) {
                this.generateQR();
            }
        };
        reader.onerror = () => {
            this.showErrorMessage('Failed to read file.');
        };
        reader.readAsDataURL(file);
    }

    downloadQR(format) {
        if (!this.qrCode) return;
        
        try {
            const filename = `vinnesia-qr-${Date.now()}`;
            this.qrCode.download({ 
                name: filename, 
                extension: format 
            });
        } catch (error) {
            console.error('Download failed:', error);
            this.showErrorMessage('Failed to download QR code. Please try again.');
        }
    }

    async logout() {
        try {
            // Try Firebase logout first
            if (window.firebaseAuth && window.firebaseAuth.auth) {
                await window.firebaseAuth.signOut(window.firebaseAuth.auth);
            }
        } catch (error) {
            console.error('Logout error:', error);
        } finally {
            // Always clear local storage as fallback
            localStorage.removeItem('userLoggedIn');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userId');
            this.updateUIForAuthState(false);
        }
    }

    setupUI() {
        // Initialize first tab
        const firstTabButton = document.querySelector('.tab-button');
        if (firstTabButton) {
            firstTabButton.click();
        }
        
        // Setup loading states
        this.hideLoadingStates();
    }

    hideLoadingStates() {
        // Remove any loading overlays or blur effects
        document.querySelectorAll('.loading-overlay').forEach(el => el.remove());
        document.body.classList.remove('loading');
        
        // Make sure main content is visible
        const main = document.querySelector('main');
        if (main) {
            main.style.opacity = '1';
            main.style.filter = 'none';
        }
    }

    showErrorMessage(message) {
        // Create or update error message
        let errorDiv = document.getElementById('error-message');
        
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ff4444, #cc0000);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                font-weight: bold;
                max-width: 300px;
                word-wrap: break-word;
                animation: slideIn 0.3s ease-out;
            `;
            
            // Add slide in animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(errorDiv);
        }
        
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        
        // Auto hide after 5 seconds
        setTimeout(() => {
            if (errorDiv) {
                errorDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (errorDiv && errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 300);
            }
        }, 5000);
        
        // Click to dismiss
        errorDiv.addEventListener('click', () => {
            errorDiv.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (errorDiv && errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 300);
        });
    }

    showSuccessMessage(message) {
        let successDiv = document.getElementById('success-message');
        
        if (!successDiv) {
            successDiv = document.createElement('div');
            successDiv.id = 'success-message';
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4CAF50, #2E7D32);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                font-weight: bold;
                max-width: 300px;
                word-wrap: break-word;
                animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(successDiv);
        }
        
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        
        // Auto hide after 3 seconds
        setTimeout(() => {
            if (successDiv) {
                successDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (successDiv && successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 300);
            }
        }, 3000);
        
        successDiv.addEventListener('click', () => {
            successDiv.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (successDiv && successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 300);
        });
    }

    // Utility method to validate inputs
    validateInput(tabName) {
        const validators = {
            'text': () => {
                const input = document.getElementById('text-input');
                const value = input ? input.value.trim() : '';
                if (!value) {
                    this.showErrorMessage('Please enter some text or URL.');
                    return false;
                }
                return true;
            },
            
            'wifi': () => {
                const ssid = document.getElementById('wifi-ssid');
                if (!ssid || !ssid.value.trim()) {
                    this.showErrorMessage('Please enter WiFi network name (SSID).');
                    return false;
                }
                return true;
            },
            
            'vcard': () => {
                const name = document.getElementById('vcard-name');
                if (!name || !name.value.trim()) {
                    this.showErrorMessage('Please enter a name for the contact.');
                    return false;
                }
                return true;
            },
            
            'email': () => {
                const email = document.getElementById('email-to');
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!email || !email.value.trim()) {
                    this.showErrorMessage('Please enter recipient email address.');
                    return false;
                }
                if (!emailPattern.test(email.value.trim())) {
                    this.showErrorMessage('Please enter a valid email address.');
                    return false;
                }
                return true;
            },
            
            'sms': () => {
                const phone = document.getElementById('sms-to');
                if (!phone || !phone.value.trim()) {
                    this.showErrorMessage('Please enter a phone number.');
                    return false;
                }
                return true;
            },
            
            'geo': () => {
                const lat = document.getElementById('geo-lat');
                const lon = document.getElementById('geo-lon');
                if (!lat || !lon || !lat.value.trim() || !lon.value.trim()) {
                    this.showErrorMessage('Please enter both latitude and longitude.');
                    return false;
                }
                
                const latVal = parseFloat(lat.value);
                const lonVal = parseFloat(lon.value);
                if (isNaN(latVal) || isNaN(lonVal) || latVal < -90 || latVal > 90 || lonVal < -180 || lonVal > 180) {
                    this.showErrorMessage('Please enter valid coordinates (lat: -90 to 90, lon: -180 to 180).');
                    return false;
                }
                return true;
            },
            
            'phone': () => {
                const phone = document.getElementById('phone-number');
                if (!phone || !phone.value.trim()) {
                    this.showErrorMessage('Please enter a phone number.');
                    return false;
                }
                return true;
            },
            
            'whatsapp': () => {
                const phone = document.getElementById('whatsapp-number');
                if (!phone || !phone.value.trim()) {
                    this.showErrorMessage('Please enter a WhatsApp phone number.');
                    return false;
                }
                return true;
            },
            
            'crypto': () => {
                const address = document.getElementById('crypto-address');
                if (!address || !address.value.trim()) {
                    this.showErrorMessage('Please enter a cryptocurrency wallet address.');
                    return false;
                }
                return true;
            }
        };
        
        const validator = validators[tabName];
        return validator ? validator() : true;
    }

    // Enhanced generateQR with validation
    generateQR() {
        if (!this.qrCode) {
            this.showErrorMessage('QR Code generator not ready. Please refresh the page.');
            return;
        }
        
        // Validate input for current tab
        if (!this.validateInput(this.currentTab)) {
            return;
        }
        
        try {
            const data = this.getQRData();
            if (!data || data.trim() === '') {
                this.showErrorMessage('Please provide valid data to generate QR code.');
                return;
            }
            
            const options = this.getQROptions();
            
            this.qrCode.update({
                data: data,
                ...options
            });
            
            this.removePreviewWatermark();
            this.updateQRContainer(options.backgroundOptions.color);
            this.showSuccessMessage('QR Code generated successfully!');
            
        } catch (error) {
            console.error('Error generating QR code:', error);
            this.showErrorMessage('Error generating QR code. Please check your input and try again.');
        }
    }

    // Performance optimization: Lazy load heavy operations
    async performHeavyOperation(operation) {
        return new Promise((resolve) => {
            setTimeout(() => {
                resolve(operation());
            }, 0);
        });
    }

    // Enhanced error handling with retry mechanism
    async retryOperation(operation, maxRetries = 3, delay = 1000) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                return await operation();
            } catch (error) {
                if (i === maxRetries - 1) throw error;
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2; // Exponential backoff
            }
        }
    }

    // Accessibility improvements
    setupAccessibility() {
        // Add ARIA labels and roles
        const generateBtn = document.getElementById('generate-btn');
        if (generateBtn) {
            generateBtn.setAttribute('aria-describedby', 'generate-description');
            generateBtn.setAttribute('role', 'button');
            
            // Add description
            const description = document.createElement('div');
            description.id = 'generate-description';
            description.className = 'sr-only';
            description.textContent = 'Generate QR code with the provided information';
            generateBtn.appendChild(description);
        }
        
        // Add keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.classList.contains('tab-button')) {
                e.target.click();
            }
        });
        
        // Focus management for modal
        const modal = document.getElementById('login-modal');
        if (modal) {
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.hideLoginModal();
                }
                
                // Trap focus within modal
                if (e.key === 'Tab') {
                    const focusableElements = modal.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];
                    
                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            lastElement.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            firstElement.focus();
                            e.preventDefault();
                        }
                    }
                }
            });
        }
    }

    // Progressive enhancement
    enhanceUI() {
        // Add loading states to buttons
        const buttons = document.querySelectorAll('.btn');
        buttons.forEach(button => {
            const originalText = button.textContent;
            
            button.addEventListener('click', function() {
                if (this.disabled) return;
                
                this.disabled = true;
                this.textContent = 'Loading...';
                
                setTimeout(() => {
                    this.disabled = false;
                    this.textContent = originalText;
                }, 1000);
            });
        });
        
        // Add smooth transitions
        const style = document.createElement('style');
        style.textContent = `
            .tab-content {
                transition: opacity 0.3s ease-in-out;
            }
            .tab-content:not(.active) {
                opacity: 0;
                pointer-events: none;
            }
            .tab-content.active {
                opacity: 1;
                pointer-events: auto;
            }
            
            .btn {
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }
            
            .btn::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
            }
            
            .btn:active::before {
                width: 300px;
                height: 300px;
            }
            
            .form-group input:focus,
            .form-group textarea:focus,
            .form-group select:focus {
                outline: 2px solid var(--color-secondary);
                outline-offset: 2px;
                box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
            }
        `;
        document.head.appendChild(style);
    }

    // Mobile optimizations
    setupMobileOptimizations() {
        // Touch-friendly interactions
        if ('ontouchstart' in window) {
            document.body.classList.add('touch-device');
            
            // Improve touch targets
            const style = document.createElement('style');
            style.textContent = `
                .touch-device .btn {
                    min-height: 48px;
                    padding: 12px 20px;
                }
                
                .touch-device .tab-button {
                    min-height: 48px;
                    padding: 12px 16px;
                }
                
                .touch-device input,
                .touch-device textarea,
                .touch-device select {
                    min-height: 48px;
                    font-size: 16px; /* Prevent zoom on iOS */
                }
            `;
            document.head.appendChild(style);
        }
        
        // Handle orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                this.adjustLayoutForOrientation();
            }, 100);
        });
    }

    adjustLayoutForOrientation() {
        const main = document.querySelector('main');
        if (!main) return;
        
        if (window.innerHeight < window.innerWidth && window.innerWidth < 1024) {
            // Landscape mode on tablet/mobile
            main.style.flexDirection = 'row';
        } else {
            // Portrait mode or desktop
            main.style.flexDirection = window.innerWidth > 992 ? 'row' : 'column';
        }
    }

    // Analytics and monitoring (privacy-friendly)
    trackEvent(eventName, eventData = {}) {
        // Only track if user has consented and is logged in
        if (this.isUserLoggedIn && window.gtag) {
            window.gtag('event', eventName, {
                custom_parameter: eventData,
                non_interaction: true
            });
        }
    }

    // Cleanup method
    destroy() {
        // Clear timeouts
        if (this.previewTimeout) {
            clearTimeout(this.previewTimeout);
        }
        
        // Remove event listeners
        document.removeEventListener('keydown', this.handleKeydown);
        window.removeEventListener('orientationchange', this.handleOrientationChange);
        
        // Clear QR code
        if (this.qrCode) {
            const container = document.getElementById('qr-code');
            if (container) {
                container.innerHTML = '';
            }
        }
        
        // Clear messages
        const errorMsg = document.getElementById('error-message');
        const successMsg = document.getElementById('success-message');
        if (errorMsg) errorMsg.remove();
        if (successMsg) successMsg.remove();
    }
}

// Initialize the application
const qrGenerator = new QRGenerator();

// Wait for DOM to be ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        qrGenerator.init();
    });
} else {
    qrGenerator.init();
}

// Handle page visibility changes for performance
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        // Page is hidden, pause heavy operations
        if (qrGenerator.previewTimeout) {
            clearTimeout(qrGenerator.previewTimeout);
        }
    } else {
        // Page is visible again, resume operations
        if (!qrGenerator.isUserLoggedIn) {
            setTimeout(() => {
                qrGenerator.generatePreviewQR();
            }, 100);
        }
    }
});

// Handle beforeunload for cleanup
window.addEventListener('beforeunload', () => {
    if (qrGenerator && qrGenerator.destroy) {
        qrGenerator.destroy();
    }
});

// Expose qrGenerator globally for debugging (in development only)
if (typeof window !== 'undefined' && window.location.hostname === 'localhost') {
    window.qrGenerator = qrGenerator;
}

// Service Worker registration for offline support (optional)
if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('SW registered: ', registration);
            })
            .catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}

</script>
</body>
</html>
